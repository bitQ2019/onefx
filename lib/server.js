"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
exports.Server = void 0;

var _koa = _interopRequireDefault(require("koa"));

var _koaRouter = _interopRequireDefault(require("koa-router"));

var _methods = _interopRequireDefault(require("methods"));

var _os = require("os");

var _integratedGateways = require("./integrated-gateways/integrated-gateways");

var _middleware = require("./middleware");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

class Server {
  constructor(config) {
    this.config = config;
    this.gateways = new _integratedGateways.IntegratedGateways(config);
    this.processTitle = `nodejs-${config.project}-on-${(0, _os.hostname)()}`;
    this.app = new _koa.default();
    this.logger = this.gateways.logger;
    this.initRouter();
    this.app.keys = config.server.cookie.secrets;

    if (!this.config.server.delayInitMiddleware) {
      (0, _middleware.initMiddleware)(this);
    }
  }

  initMiddleware() {
    (0, _middleware.initMiddleware)(this);
  }

  initRouter() {
    const router = new _koaRouter.default();

    const setRouterOnVerb = (verb) => {
      // @ts-ignore
      this[verb] = (...argu) => {
        const args = [...argu];
        let koaRoute = args.shift();

        if (typeof args[0] === "string") {
          koaRoute = args.shift();
        }

        let routePrefix = this.config.server.routePrefix;

        if (routePrefix) {
          if (routePrefix[routePrefix.length - 1] !== "/") {
            routePrefix = `${routePrefix}/`;
          }

          if (koaRoute[0] === "/") {
            koaRoute = koaRoute.substr(1);
          }

          koaRoute = `${routePrefix}${koaRoute}`;
        }

        args.unshift(koaRoute); // @ts-ignore

        return router[verb](...args);
      };
    };

    _methods.default.forEach(setRouterOnVerb);

    setRouterOnVerb("all");
    this.router = router;
    this.app.use(router.routes());
  } // tslint:disable-next-line

  use(...args) {
    if (typeof args[0] === "function") {
      // default route to '/'
      args.unshift("/");
    }

    this.router.use(...args);
  }

  listen(port, done = (_) => null) {
    this.httpServer = this.app.listen(port, () => {
      this.logger.info(
        `${this.processTitle} listening on http://localhost:${port}`
      );
      return done(this);
    });
    return this.httpServer;
  }

  close(done = () => null) {
    this.gateways.close();

    if (this.httpServer) {
      this.httpServer.close(done);
    }
  }
}

exports.Server = Server;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIudHMiXSwibmFtZXMiOlsiU2VydmVyIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJnYXRld2F5cyIsIkludGVncmF0ZWRHYXRld2F5cyIsInByb2Nlc3NUaXRsZSIsInByb2plY3QiLCJhcHAiLCJLb2EiLCJsb2dnZXIiLCJpbml0Um91dGVyIiwia2V5cyIsInNlcnZlciIsImNvb2tpZSIsInNlY3JldHMiLCJkZWxheUluaXRNaWRkbGV3YXJlIiwiaW5pdE1pZGRsZXdhcmUiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJzZXRSb3V0ZXJPblZlcmIiLCJ2ZXJiIiwiYXJndSIsImFyZ3MiLCJrb2FSb3V0ZSIsInNoaWZ0Iiwicm91dGVQcmVmaXgiLCJsZW5ndGgiLCJzdWJzdHIiLCJ1bnNoaWZ0IiwibWV0aG9kcyIsImZvckVhY2giLCJ1c2UiLCJyb3V0ZXMiLCJsaXN0ZW4iLCJwb3J0IiwiZG9uZSIsIl8iLCJodHRwU2VydmVyIiwiaW5mbyIsImNsb3NlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7QUE2Q08sTUFBTUEsTUFBTixDQUFhO0FBb0JsQkMsRUFBQUEsV0FBVyxDQUFDQyxNQUFELEVBQWlCO0FBQzFCLFNBQUtBLE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtDLFFBQUwsR0FBZ0IsSUFBSUMsc0NBQUosQ0FBdUJGLE1BQXZCLENBQWhCO0FBQ0EsU0FBS0csWUFBTCxHQUFxQixVQUFTSCxNQUFNLENBQUNJLE9BQVEsT0FBTSxtQkFBVyxFQUE5RDtBQUNBLFNBQUtDLEdBQUwsR0FBVyxJQUFJQyxZQUFKLEVBQVg7QUFDQSxTQUFLQyxNQUFMLEdBQWMsS0FBS04sUUFBTCxDQUFjTSxNQUE1QjtBQUNBLFNBQUtDLFVBQUw7QUFFQSxTQUFLSCxHQUFMLENBQVNJLElBQVQsR0FBZ0JULE1BQU0sQ0FBQ1UsTUFBUCxDQUFjQyxNQUFkLENBQXFCQyxPQUFyQzs7QUFDQSxRQUFJLENB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cCBmcm9tIFwiaHR0cFwiO1xuaW1wb3J0IEtvYSBmcm9tIFwia29hXCI7XG5pbXBvcnQgUm91dGVyIGZyb20gXCJrb2Etcm91dGVyXCI7XG5pbXBvcnQgbWV0aG9kcyBmcm9tIFwibWV0aG9kc1wiO1xuaW1wb3J0IHsgaG9zdG5hbWUgfSBmcm9tIFwib3NcIjtcbmltcG9ydCB7IEludGVncmF0ZWRHYXRld2F5cyB9IGZyb20gXCIuL2ludGVncmF0ZWQtZ2F0ZXdheXMvaW50ZWdyYXRlZC1nYXRld2F5c1wiO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSBcIi4vaW50ZWdyYXRlZC1nYXRld2F5cy9sb2dnZXJcIjtcbmltcG9ydCB7IGluaXRNaWRkbGV3YXJlIH0gZnJvbSBcIi4vbWlkZGxld2FyZVwiO1xuaW1wb3J0IHsgTWlkZGxld2FyZSB9IGZyb20gXCIuL3R5cGVzXCI7XG5cbmV4cG9ydCB0eXBlIENvbmZpZyA9IHtcbiAgcHJvamVjdDogc3RyaW5nO1xuICBzZXJ2ZXI6IHtcbiAgICBob3N0OiBzdHJpbmc7XG4gICAgcG9ydDogc3RyaW5nO1xuICAgIHN0YXRpY0Rpcjogc3RyaW5nO1xuICAgIHJvdXRlUHJlZml4Pzogc3RyaW5nO1xuICAgIGNkbkJhc2U/OiBzdHJpbmc7XG4gICAgZGVsYXlJbml0TWlkZGxld2FyZTogYm9vbGVhbjtcbiAgICBjb29raWU6IHtcbiAgICAgIHNlY3JldHM6IEFycmF5PHN0cmluZz47XG4gICAgfTtcbiAgICBub1NlY3VyaXR5SGVhZGVyc1JvdXRlczoge1xuICAgICAgW3ByZWZpeDogc3RyaW5nXTogYm9vbGVhbjtcbiAgICB9O1xuICAgIG5vQ3NyZlJvdXRlczoge1xuICAgICAgW3ByZWZpeDogc3RyaW5nXTogYm9vbGVhbjtcbiAgICB9O1xuICB9O1xuICBnYXRld2F5czoge1xuICAgIGxvZ2dlcjoge1xuICAgICAgZW5hYmxlZDogYm9vbGVhbjtcbiAgICAgIGJhc2VEaXI6IHN0cmluZztcbiAgICAgIHRvcGljTmFtZTogc3RyaW5nO1xuICAgICAgbGV2ZWw6IFwiZGVidWdcIiB8IFwiaW5mb1wiIHwgXCJ3YXJuXCIgfCBcImVycm9yXCI7XG4gICAgfTtcbiAgfTtcbiAgY3NwOiB7XG4gICAgW2tleTogc3RyaW5nXTogQXJyYXk8c3RyaW5nPjtcbiAgfTtcbiAgYW5hbHl0aWNzOiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nO1xuICB9O1xuICBzZXNzaW9uOiB7fTtcbn07XG5cbnR5cGUgU2V0Um91dGUgPSAoXG4gIG5hbWU6IHN0cmluZyxcbiAgcm91dGU6IHN0cmluZyB8IFJlZ0V4cCxcbiAgLi4uaGFuZGxlcjogQXJyYXk8TWlkZGxld2FyZT5cbikgPT4gdm9pZDtcblxuZXhwb3J0IGNsYXNzIFNlcnZlciB7XG4gIHB1YmxpYyBhcHA6IEtvYTtcbiAgcHVibGljIGdhdGV3YXlzOiBJbnRlZ3JhdGVkR2F0ZXdheXM7XG4gIHB1YmxpYyBsb2dnZXI6IExvZ2dlcjtcbiAgcHVibGljIGNvbmZpZzogQ29uZmlnO1xuICBwdWJsaWMgaHR0cFNlcnZlcj86IGh0dHAuU2VydmVyO1xuICBwdWJsaWMgcm91dGVyOiBSb3V0ZXI7XG4gIHB1YmxpYyBwcm9jZXNzVGl0bGU6IHN0cmluZztcblxuICBwdWJsaWMgYWxsOiBTZXRSb3V0ZTtcbiAgcHVibGljIGdldDogU2V0Um91dGU7XG4gIHB1YmxpYyBwb3N0OiBTZXRSb3V0ZTtcbiAgcHVibGljIHB1dDogU2V0Um91dGU7XG4gIHB1YmxpYyBoZWFkOiBTZXRSb3V0ZTtcbiAgcHVibGljIGRlbGV0ZTogU2V0Um91dGU7XG4gIHB1YmxpYyBvcHRpb25zOiBTZXRSb3V0ZTtcbiAgcHVibGljIHRyYWNlOiBTZXRSb3V0ZTtcbiAgcHVibGljIGNvcHk6IFNldFJvdXRlO1xuICBwdWJsaWMgbG9jazogU2V0Um91dGU7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLmdhdGV3YXlzID0gbmV3IEludGVncmF0ZWRHYXRld2F5cyhjb25maWcpO1xuICAgIHRoaXMucHJvY2Vzc1RpdGxlID0gYG5vZGVqcy0ke2NvbmZpZy5wcm9qZWN0fS1vbi0ke2hvc3RuYW1lKCl9YDtcbiAgICB0aGlzLmFwcCA9IG5ldyBLb2EoKTtcbiAgICB0aGlzLmxvZ2dlciA9IHRoaXMuZ2F0ZXdheXMubG9nZ2VyO1xuICAgIHRoaXMuaW5pdFJvdXRlcigpO1xuXG4gICAgdGhpcy5hcHAua2V5cyA9IGNvbmZpZy5zZXJ2ZXIuY29va2llLnNlY3JldHM7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5zZXJ2ZXIuZGVsYXlJbml0TWlkZGxld2FyZSkge1xuICAgICAgaW5pdE1pZGRsZXdhcmUodGhpcyk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGluaXRNaWRkbGV3YXJlKCk6IHZvaWQge1xuICAgIGluaXRNaWRkbGV3YXJlKHRoaXMpO1xuICB9XG5cbiAgcHVibGljIGluaXRSb3V0ZXIoKTogdm9pZCB7XG4gICAgY29uc3Qgcm91dGVyID0gbmV3IFJvdXRlcigpO1xuICAgIGNvbnN0IHNldFJvdXRlck9uVmVyYiA9ICh2ZXJiOiBzdHJpbmcpID0+IHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHRoaXNbdmVyYl0gPSAoLi4uYXJndSkgPT4ge1xuICAgICAgICBjb25zdCBhcmdzID0gWy4uLmFyZ3VdO1xuXG4gICAgICAgIGxldCBrb2FSb3V0ZSA9IGFyZ3Muc2hpZnQoKTtcbiAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzBdID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAga29hUm91dGUgPSBhcmdzLnNoaWZ0KCk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHJvdXRlUHJlZml4ID0gdGhpcy5jb25maWcuc2VydmVyLnJvdXRlUHJlZml4O1xuICAgICAgICBpZiAocm91dGVQcmVmaXgpIHtcbiAgICAgICAgICBpZiAocm91dGVQcmVmaXhbcm91dGVQcmVmaXgubGVuZ3RoIC0gMV0gIT09IFwiL1wiKSB7XG4gICAgICAgICAgICByb3V0ZVByZWZpeCA9IGAke3JvdXRlUHJlZml4fS9gO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoa29hUm91dGVbMF0gPT09IFwiL1wiKSB7XG4gICAgICAgICAgICBrb2FSb3V0ZSA9IGtvYVJvdXRlLnN1YnN0cigxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAga29hUm91dGUgPSBgJHtyb3V0ZVByZWZpeH0ke2tvYVJvdXRlfWA7XG4gICAgICAgIH1cbiAgICAgICAgYXJncy51bnNoaWZ0KGtvYVJvdXRlKTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gcm91dGVyW3ZlcmJdKC4uLmFyZ3MpO1xuICAgICAgfTtcbiAgICB9O1xuXG4gICAgbWV0aG9kcy5mb3JFYWNoKHNldFJvdXRlck9uVmVyYik7XG4gICAgc2V0Um91dGVyT25WZXJiKFwiYWxsXCIpO1xuXG4gICAgdGhpcy5yb3V0ZXIgPSByb3V0ZXI7XG4gICAgdGhpcy5hcHAudXNlKHJvdXRlci5yb3V0ZXMoKSk7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgcHVibGljIHVzZSguLi5hcmdzOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodHlwZW9mIGFyZ3NbMF0gPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgLy8gZGVmYXVsdCByb3V0ZSB0byAnLydcbiAgICAgIGFyZ3MudW5zaGlmdChcIi9cIik7XG4gICAgfVxuICAgIHRoaXMucm91dGVyLnVzZSguLi5hcmdzKTtcbiAgfVxuXG4gIHB1YmxpYyBsaXN0ZW4oXG4gICAgcG9ydDogbnVtYmVyLFxuICAgIGRvbmU6IExpc3RlbkRvbmUgPSAoXzogU2VydmVyKSA9PiBudWxsXG4gICk6IGh0dHAuU2VydmVyIHtcbiAgICB0aGlzLmh0dHBTZXJ2ZXIgPSB0aGlzLmFwcC5saXN0ZW4ocG9ydCwgKCkgPT4ge1xuICAgICAgdGhpcy5sb2dnZXIuaW5mbyhcbiAgICAgICAgYCR7dGhpcy5wcm9jZXNzVGl0bGV9IGxpc3RlbmluZyBvbiBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gXG4gICAgICApO1xuICAgICAgcmV0dXJuIGRvbmUodGhpcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFNlcnZlcjtcbiAgfVxuXG4gIHB1YmxpYyBjbG9zZShkb25lOiBDbG9zZURvbmUgPSAoKSA9PiBudWxsKTogdm9pZCB7XG4gICAgdGhpcy5nYXRld2F5cy5jbG9zZSgpO1xuICAgIGlmICh0aGlzLmh0dHBTZXJ2ZXIpIHtcbiAgICAgIHRoaXMuaHR0cFNlcnZlci5jbG9zZShkb25lKTtcbiAgICB9XG4gIH1cbn1cblxudHlwZSBMaXN0ZW5Eb25lID0gKHNlcnZlcjogU2VydmVyKSA9PiB2b2lkO1xudHlwZSBDbG9zZURvbmUgPSAoKSA9PiB2b2lkO1xuIl19
