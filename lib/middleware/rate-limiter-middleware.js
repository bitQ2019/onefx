"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
exports.createRateLimiter = createRateLimiter;

var _crypto = _interopRequireDefault(require("crypto"));

var _koa2Ratelimit = require("koa2-ratelimit");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

// @ts-ignore
function createRateLimiter(server, opts) {
  return _koa2Ratelimit.RateLimit.middleware({
    interval: opts.interval,
    max: opts.max,

    async keyGenerator(ctx) {
      const sha1 = _crypto.default.createHash("sha1");

      sha1.update(opts.generateKey(ctx));
      const shorten = sha1.digest().toString("base64");
      const key = `${opts.name || "unnamed"}|${shorten}`;
      server.logger.debug(`ratelimit key ${key}`);
      return key;
    },

    async handler(ctx) {
      ctx.status = 429;
      ctx.body = {
        ok: false,
        error: {
          code: "RATE_LIMIT",
          message: ctx.i18n.__("rate_limit"),
        },
      };
    },
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL3JhdGUtbGltaXRlci1taWRkbGV3YXJlLnRzIl0sIm5hbWVzIjpbImNyZWF0ZVJhdGVMaW1pdGVyIiwic2VydmVyIiwib3B0cyIsIlJhdGVMaW1pdCIsIm1pZGRsZXdhcmUiLCJpbnRlcnZhbCIsIm1heCIsImtleUdlbmVyYXRvciIsImN0eCIsInNoYTEiLCJjcnlwdG8iLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZ2VuZXJhdGVLZXkiLCJzaG9ydGVuIiwiZGlnZXN0IiwidG9TdHJpbmciLCJrZXkiLCJuYW1lIiwibG9nZ2VyIiwiZGVidWciLCJoYW5kbGVyIiwic3RhdHVzIiwiYm9keSIsIm9rIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsImkxOG4iLCJfXyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOzs7O0FBREE7QUFZTyxTQUFTQSxpQkFBVCxDQUNMQyxNQURLLEVBRUxDLElBRkssRUFHTztBQUNaLFNBQU9DLHlCQUFVQyxVQUFWLENBQXFCO0FBQzFCQyxJQUFBQSxRQUFRLEVBQUVILElBQUksQ0FBQ0csUUFEVztBQUUxQkMsSUFBQUEsR0FBRyxFQUFFSixJQUFJLENBQUNJLEdBRmdCOztBQUcxQixVQUFNQyxZQUFOLENBQW1CQyxHQUFuQixFQUFrRDtBQUNoRCxZQUFNQyxJQUFJLEdBQUdDLGdCQUFPQyxVQUFQLENBQWtCLE1BQWxCLENBQWI7O0FBQ0FGLE1BQUFBLElBQUksQ0FBQ0csTUFBTCxDQUFZVixJQUFJLENBQUNXLFdBQUwsQ0FBaUJMLEdBQWpCLENBQVo7QUFDQSxZQUFNTSxPQUFPLEdBQUdMLElBQUksQ0FBQ00sTUFBTCxHQUFjQyxRQUFkLENBQXVCLFFBQXZCLENBQWhCO0FBQ0EsWUFBTUMsR0FBRyxHQUFJLEdBQUVmLElBQUksQ0FBQ2dCLElBQUwsSUFBYSxTQUFVLElBQUdKLE9BQVEsRUFBakQ7QUFDQWIsTUFBQUEsTUFBTSxDQUFDa0IsTUFBUCxDQUFjQyxLQUFkLENBQXFCLGlCQUFnQkgsR0FBSSxFQUF6QztBQUNBLGFBQU9BLEdBQVA7QUFDRCxLQVZ5Qjs7QUFXMUIsVUFBTUksT0FBTixDQUFjYixHQUFkLEVBQTJDO0FBQ3pDQSxNQUFBQSxHQUFHLENBQUNjLE1BQUosR0FBYSxHQUFiO0FBQ0FkLE1BQUFBLEdBQUcsQ0FBQ2UsSUFBSixHQUFXO0FBQ1RDLFFBQUFBLEVBQUUsRUFBRSxLQURLO0FBRVRDLFFBQUFBLEtBQUssRUFBRTtBQUFFQyxVQUFBQSxJQUFJLEVBQUUsWUFBUjtBQUFzQkMsVUFBQUEsT0FBTyxFQUFFbkIsR0FBRyxDQUFDb0IsSUFBSixDQUFTQyxFQUFULENBQVksWUFBWjtBQUEvQjtBQUZFLE9BQVg7QUFJRDs7QUFqQnlCLEdBQXJCLENBQVA7QUFtQkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gXCJjcnlwdG9cIjtcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCB7IFJhdGVMaW1pdCB9IGZyb20gXCJrb2EyLXJhdGVsaW1pdFwiO1xuaW1wb3J0IHsgU2VydmVyIH0gZnJvbSBcIi4uL3NlcnZlclwiO1xuaW1wb3J0IHsgQ29udGV4dCwgTWlkZGxld2FyZSB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBSYXRlTGltaXRlck9wdHMgPSB7XG4gIG5hbWU6IHN0cmluZztcbiAgZ2VuZXJhdGVLZXkoY3R4OiBDb250ZXh0KTogc3RyaW5nO1xuICBpbnRlcnZhbDogbnVtYmVyOyAvLyBtc1xuICBtYXg6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSYXRlTGltaXRlcihcbiAgc2VydmVyOiBTZXJ2ZXIsXG4gIG9wdHM6IFJhdGVMaW1pdGVyT3B0c1xuKTogTWlkZGxld2FyZSB7XG4gIHJldHVybiBSYXRlTGltaXQubWlkZGxld2FyZSh7XG4gICAgaW50ZXJ2YWw6IG9wdHMuaW50ZXJ2YWwsXG4gICAgbWF4OiBvcHRzLm1heCxcbiAgICBhc3luYyBrZXlHZW5lcmF0b3IoY3R4OiBDb250ZXh0KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgIGNvbnN0IHNoYTEgPSBjcnlwdG8uY3JlYXRlSGFzaChcInNoYTFcIik7XG4gICAgICBzaGExLnVwZGF0ZShvcHRzLmdlbmVyYXRlS2V5KGN0eCkpO1xuICAgICAgY29uc3Qgc2hvcnRlbiA9IHNoYTEuZGlnZXN0KCkudG9TdHJpbmcoXCJiYXNlNjRcIik7XG4gICAgICBjb25zdCBrZXkgPSBgJHtvcHRzLm5hbWUgfHwgXCJ1bm5hbWVkXCJ9fCR7c2hvcnRlbn1gO1xuICAgICAgc2VydmVyLmxvZ2dlci5kZWJ1ZyhgcmF0ZWxpbWl0IGtleSAke2tleX1gKTtcbiAgICAgIHJldHVybiBrZXk7XG4gICAgfSxcbiAgICBhc3luYyBoYW5kbGVyKGN0eDogQ29udGV4dCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgY3R4LnN0YXR1cyA9IDQyOTtcbiAgICAgIGN0eC5ib2R5ID0ge1xuICAgICAgICBvazogZmFsc2UsXG4gICAgICAgIGVycm9yOiB7IGNvZGU6IFwiUkFURV9MSU1JVFwiLCBtZXNzYWdlOiBjdHguaTE4bi5fXyhcInJhdGVfbGltaXRcIikgfVxuICAgICAgfTtcbiAgICB9XG4gIH0pO1xufVxuIl19
