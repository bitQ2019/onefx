"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
exports.csrfMiddleware = csrfMiddleware;
exports.isPrefixMatched = isPrefixMatched;

var _dottie = _interopRequireDefault(require("dottie"));

var _koaCsrf = _interopRequireDefault(require("koa-csrf"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

function csrfMiddleware(server) {
  const csrf = new _koaCsrf.default({
    invalidSessionSecretMessage: "Invalid session secret",
    invalidSessionSecretStatusCode: 403,
    invalidTokenMessage: "Invalid CSRF token",
    invalidTokenStatusCode: 403,
    excludedMethods: ["GET", "HEAD", "OPTIONS"],
    disableQuery: false,
  });
  const noCsrfRoutes =
    _dottie.default.get(server, "config.server.noCsrfRoutes") || {};
  return async (ctx, next) => {
    // @ts-ignore
    if (isPrefixMatched(noCsrfRoutes, ctx.path)) {
      return next();
    }

    await csrf(ctx, next);
  };
}

function isPrefixMatched(prefixes, target) {
  for (const prefix of Object.keys(prefixes)) {
    if (String(target).startsWith(prefix) && prefixes[prefix]) {
      return true;
    }
  }

  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2NzcmYtbWlkZGxld2FyZS50cyJdLCJuYW1lcyI6WyJjc3JmTWlkZGxld2FyZSIsInNlcnZlciIsImNzcmYiLCJDU1JGIiwiaW52YWxpZFNlc3Npb25TZWNyZXRNZXNzYWdlIiwiaW52YWxpZFNlc3Npb25TZWNyZXRTdGF0dXNDb2RlIiwiaW52YWxpZFRva2VuTWVzc2FnZSIsImludmFsaWRUb2tlblN0YXR1c0NvZGUiLCJleGNsdWRlZE1ldGhvZHMiLCJkaXNhYmxlUXVlcnkiLCJub0NzcmZSb3V0ZXMiLCJkb3R0eSIsImdldCIsImN0eCIsIm5leHQiLCJpc1ByZWZpeE1hdGNoZWQiLCJwYXRoIiwicHJlZml4ZXMiLCJ0YXJnZXQiLCJwcmVmaXgiLCJPYmplY3QiLCJrZXlzIiwiU3RyaW5nIiwic3RhcnRzV2l0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQU1PLFNBQVNBLGNBQVQsQ0FBd0JDLE1BQXhCLEVBQW9EO0FBQ3pELFFBQU1DLElBQUksR0FBRyxJQUFJQyxnQkFBSixDQUFTO0FBQ3BCQyxJQUFBQSwyQkFBMkIsRUFBRSx3QkFEVDtBQUVwQkMsSUFBQUEsOEJBQThCLEVBQUUsR0FGWjtBQUdwQkMsSUFBQUEsbUJBQW1CLEVBQUUsb0JBSEQ7QUFJcEJDLElBQUFBLHNCQUFzQixFQUFFLEdBSko7QUFLcEJDLElBQUFBLGVBQWUsRUFBRSxDQUFDLEtBQUQsRUFBUSxNQUFSLEVBQWdCLFNBQWhCLENBTEc7QUFNcEJDLElBQUFBLFlBQVksRUFBRTtBQU5NLEdBQVQsQ0FBYjtBQVFBLFFBQU1DLFlBQVksR0FBR0MsZ0JBQU1DLEdBQU4sQ0FBVVgsTUFBVixFQUFrQiw0QkFBbEIsS0FBbUQsRUFBeEU7QUFFQSxTQUFPLE9BQU9ZLEdBQVAsRUFBcUJDLElBQXJCLEtBQW9DO0FBQ3pDO0FBQ0EsUUFBSUMsZUFBZSxDQUFDTCxZQUFELEVBQWVHLEdBQUcsQ0FBQ0csSUFBbkIsQ0FBbkIsRUFBNkM7QUFDM0MsYUFBT0YsSUFBSSxFQUFYO0FBQ0Q7O0FBQ0QsVUFBTVosSUFBSSxDQUFDVyxHQUFELEVBQU1DLElBQU4sQ0FBVjtBQUNELEdBTkQ7QUFPRDs7QUFFTSxTQUFTQyxlQUFULENBQXlCRSxRQUF6QixFQUE2Q0MsTUFBN0MsRUFBc0U7QUFDM0UsT0FBSyxNQUFNQyxNQUFYLElBQXFCQyxNQUFNLENBQUNDLElBQVAsQ0FBWUosUUFBWixDQUFyQixFQUE0QztBQUMxQyxRQUFJSyxNQUFNLENBQUNKLE1BQUQsQ0FBTixDQUFlSyxVQUFmLENBQTBCSixNQUExQixLQUFxQ0YsUUFBUSxDQUFDRSxNQUFELENBQWpELEVBQTJEO0FBQ3pELGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsU0FBTyxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZG90dHkgZnJvbSBcImRvdHRpZVwiO1xuaW1wb3J0IENTUkYgZnJvbSBcImtvYS1jc3JmXCI7XG5pbXBvcnQgeyBTZXJ2ZXIgfSBmcm9tIFwiLi4vc2VydmVyXCI7XG5pbXBvcnQgeyBDb250ZXh0LCBNaWRkbGV3YXJlLCBOZXh0IH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5cbnR5cGUgUHJlZml4ZXMgPSB7IFtwcmVmaXg6IHN0cmluZ106IGJvb2xlYW4gfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNzcmZNaWRkbGV3YXJlKHNlcnZlcjogU2VydmVyKTogTWlkZGxld2FyZSB7XG4gIGNvbnN0IGNzcmYgPSBuZXcgQ1NSRih7XG4gICAgaW52YWxpZFNlc3Npb25TZWNyZXRNZXNzYWdlOiBcIkludmFsaWQgc2Vzc2lvbiBzZWNyZXRcIixcbiAgICBpbnZhbGlkU2Vzc2lvblNlY3JldFN0YXR1c0NvZGU6IDQwMyxcbiAgICBpbnZhbGlkVG9rZW5NZXNzYWdlOiBcIkludmFsaWQgQ1NSRiB0b2tlblwiLFxuICAgIGludmFsaWRUb2tlblN0YXR1c0NvZGU6IDQwMyxcbiAgICBleGNsdWRlZE1ldGhvZHM6IFtcIkdFVFwiLCBcIkhFQURcIiwgXCJPUFRJT05TXCJdLFxuICAgIGRpc2FibGVRdWVyeTogZmFsc2VcbiAgfSk7XG4gIGNvbnN0IG5vQ3NyZlJvdXRlcyA9IGRvdHR5LmdldChzZXJ2ZXIsIFwiY29uZmlnLnNlcnZlci5ub0NzcmZSb3V0ZXNcIikgfHwge307XG5cbiAgcmV0dXJuIGFzeW5jIChjdHg6IENvbnRleHQsIG5leHQ6IE5leHQpID0+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgaWYgKGlzUHJlZml4TWF0Y2hlZChub0NzcmZSb3V0ZXMsIGN0eC5wYXRoKSkge1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG4gICAgYXdhaXQgY3NyZihjdHgsIG5leHQpO1xuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNQcmVmaXhNYXRjaGVkKHByZWZpeGVzOiBQcmVmaXhlcywgdGFyZ2V0OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgZm9yIChjb25zdCBwcmVmaXggb2YgT2JqZWN0LmtleXMocHJlZml4ZXMpKSB7XG4gICAgaWYgKFN0cmluZyh0YXJnZXQpLnN0YXJ0c1dpdGgocHJlZml4KSAmJiBwcmVmaXhlc1twcmVmaXhdKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuIl19
