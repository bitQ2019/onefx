"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
exports.staticServe = staticServe;

var _assert = _interopRequireDefault(require("assert"));

var _koaSend = _interopRequireDefault(require("koa-send"));

var _path = require("path");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

function staticServe(root, staticOpts) {
  const opts = staticOpts || {};
  (0, _assert.default)(root, "root directory is required to serve files"); // options

  opts.root = (0, _path.resolve)(root);

  if (opts.index !== false) {
    opts.index = opts.index || "index.html";
  }

  opts.hidden = true;
  return async (ctx, next) => {
    let done = false;

    if (ctx.method === "HEAD" || ctx.method === "GET") {
      try {
        let filePath = ctx.path;

        if (staticOpts && staticOpts.routePrefix) {
          filePath = ctx.path.replace(
            new RegExp(`^${staticOpts.routePrefix}`),
            ""
          );
        }

        done = Boolean(await (0, _koaSend.default)(ctx, filePath, opts));
      } catch (err) {
        if (err.status !== 404) {
          throw err;
        }
      }
    }

    if (!done) {
      await next();
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL3N0YXRpYy1zZXJ2ZS50cyJdLCJuYW1lcyI6WyJzdGF0aWNTZXJ2ZSIsInJvb3QiLCJzdGF0aWNPcHRzIiwib3B0cyIsImluZGV4IiwiaGlkZGVuIiwiY3R4IiwibmV4dCIsImRvbmUiLCJtZXRob2QiLCJmaWxlUGF0aCIsInBhdGgiLCJyb3V0ZVByZWZpeCIsInJlcGxhY2UiLCJSZWdFeHAiLCJCb29sZWFuIiwiZXJyIiwic3RhdHVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFPTyxTQUFTQSxXQUFULENBQXFCQyxJQUFyQixFQUFtQ0MsVUFBbkMsRUFBa0U7QUFDdkUsUUFBTUMsSUFBSSxHQUFJRCxVQUFVLElBQUksRUFBNUI7QUFFQSx1QkFBT0QsSUFBUCxFQUFhLDJDQUFiLEVBSHVFLENBS3ZFOztBQUNBRSxFQUFBQSxJQUFJLENBQUNGLElBQUwsR0FBWSxtQkFBUUEsSUFBUixDQUFaOztBQUNBLE1BQUlFLElBQUksQ0FBQ0MsS0FBTCxLQUFlLEtBQW5CLEVBQTBCO0FBQ3hCRCxJQUFBQSxJQUFJLENBQUNDLEtBQUwsR0FBYUQsSUFBSSxDQUFDQyxLQUFMLElBQWMsWUFBM0I7QUFDRDs7QUFDREQsRUFBQUEsSUFBSSxDQUFDRSxNQUFMLEdBQWMsSUFBZDtBQUVBLFNBQU8sT0FBT0MsR0FBUCxFQUFxQkMsSUFBckIsS0FBdUQ7QUFDNUQsUUFBSUMsSUFBSSxHQUFHLEtBQVg7O0FBRUEsUUFBSUYsR0FBRyxDQUFDRyxNQUFKLEtBQWUsTUFBZixJQUF5QkgsR0FBRyxDQUFDRyxNQUFKLEtBQWUsS0FBNUMsRUFBbUQ7QUFDakQsVUFBSTtBQUNGLFlBQUlDLFFBQVEsR0FBR0osR0FBRyxDQUFDSyxJQUFuQjs7QUFDQSxZQUFJVCxVQUFVLElBQUlBLFVBQVUsQ0FBQ1UsV0FBN0IsRUFBMEM7QUFDeENGLFVBQUFBLFFBQVEsR0FBR0osR0FBRyxDQUFDSyxJQUFKLENBQVNFLE9BQVQsQ0FDVCxJQUFJQyxNQUFKLENBQVksSUFBR1osVUFBVSxDQUFDVSxXQUFZLEVBQXRDLENBRFMsRUFFVCxFQUZTLENBQVg7QUFJRDs7QUFDREosUUFBQUEsSUFBSSxHQUFHTyxPQUFPLENBQUMsTUFBTSxzQkFBS1QsR0FBTCxFQUFVSSxRQUFWLEVBQW9CUCxJQUFwQixDQUFQLENBQWQ7QUFDRCxPQVRELENBU0UsT0FBT2EsR0FBUCxFQUFZO0FBQ1osWUFBSUEsR0FBRyxDQUFDQyxNQUFKLEtBQWUsR0FBbkIsRUFBd0I7QUFDdEIsZ0JBQU1ELEdBQU47QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsUUFBSSxDQUFDUixJQUFMLEVBQVc7QUFDVCxZQUFNRCxJQUFJLEVBQVY7QUFDRDtBQUNGLEdBdkJEO0FBd0JEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFzc2VydCBmcm9tIFwiYXNzZXJ0XCI7XG5pbXBvcnQgc2VuZCBmcm9tIFwia29hLXNlbmRcIjtcbmltcG9ydCB7IHJlc29sdmUgfSBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgQ29udGV4dCwgTWlkZGxld2FyZSB9IGZyb20gXCIuLi90eXBlc1wiO1xuXG50eXBlIE9wdHMgPSBzZW5kLlNlbmRPcHRpb25zICYge1xuICByb3V0ZVByZWZpeD86IHN0cmluZztcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGF0aWNTZXJ2ZShyb290OiBzdHJpbmcsIHN0YXRpY09wdHM/OiBPcHRzKTogTWlkZGxld2FyZSB7XG4gIGNvbnN0IG9wdHMgPSAoc3RhdGljT3B0cyB8fCB7fSkgYXMgc2VuZC5TZW5kT3B0aW9ucztcblxuICBhc3NlcnQocm9vdCwgXCJyb290IGRpcmVjdG9yeSBpcyByZXF1aXJlZCB0byBzZXJ2ZSBmaWxlc1wiKTtcblxuICAvLyBvcHRpb25zXG4gIG9wdHMucm9vdCA9IHJlc29sdmUocm9vdCk7XG4gIGlmIChvcHRzLmluZGV4ICE9PSBmYWxzZSkge1xuICAgIG9wdHMuaW5kZXggPSBvcHRzLmluZGV4IHx8IFwiaW5kZXguaHRtbFwiO1xuICB9XG4gIG9wdHMuaGlkZGVuID0gdHJ1ZTtcblxuICByZXR1cm4gYXN5bmMgKGN0eDogQ29udGV4dCwgbmV4dDogRnVuY3Rpb24pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBsZXQgZG9uZSA9IGZhbHNlO1xuXG4gICAgaWYgKGN0eC5tZXRob2QgPT09IFwiSEVBRFwiIHx8IGN0eC5tZXRob2QgPT09IFwiR0VUXCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBmaWxlUGF0aCA9IGN0eC5wYXRoO1xuICAgICAgICBpZiAoc3RhdGljT3B0cyAmJiBzdGF0aWNPcHRzLnJvdXRlUHJlZml4KSB7XG4gICAgICAgICAgZmlsZVBhdGggPSBjdHgucGF0aC5yZXBsYWNlKFxuICAgICAgICAgICAgbmV3IFJlZ0V4cChgXiR7c3RhdGljT3B0cy5yb3V0ZVByZWZpeH1gKSxcbiAgICAgICAgICAgIFwiXCJcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGRvbmUgPSBCb29sZWFuKGF3YWl0IHNlbmQoY3R4LCBmaWxlUGF0aCwgb3B0cykpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIuc3RhdHVzICE9PSA0MDQpIHtcbiAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWRvbmUpIHtcbiAgICAgIGF3YWl0IG5leHQoKTtcbiAgICB9XG4gIH07XG59XG4iXX0=
